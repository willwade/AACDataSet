# OpenAI Batch Helper

The `openai_batch_helper.py` script automates the process of uploading batch files to OpenAI's API, checking the status of batch jobs, downloading results, and processing them. This script is designed to work with the batch files generated by `direct_multilingual_generate.py`.

## Prerequisites

- An OpenAI API key set as an environment variable (`OPENAI_API_KEY`)
- Batch files generated using `direct_multilingual_generate.py --batch-prepare`
- Python 3.8 or higher
- The OpenAI Python library (`pip install openai`)

## Usage

### Complete Workflow

To run the complete workflow (upload, check, download, and process):

```bash
# For all languages
python scripts/openai_batch_helper.py --workflow --all

# For specific languages
python scripts/openai_batch_helper.py --workflow --lang en-GB fr-FR
```

This will:
1. Upload all batch files for the specified languages
2. Check the status of the batch jobs every 5 minutes
3. Download results when jobs are complete
4. Process the results using `transform_batch_output.py` and `augment_aac_data.py`

### Individual Steps

You can also run individual steps of the workflow:

#### Upload Batch Files

```bash
# For all languages
python scripts/openai_batch_helper.py --upload --all

# For specific languages
python scripts/openai_batch_helper.py --upload --lang en-GB fr-FR
```

This will upload all batch files for the specified languages to OpenAI's API and create batch jobs. The script will save information about the batch jobs to `batch_files/batch_jobs_info.json`.

#### Check Batch Job Status

```bash
# For all batch jobs
python scripts/openai_batch_helper.py --check --all

# For specific batch jobs
python scripts/openai_batch_helper.py --check --batch-id batch_abc123 batch_def456
```

This will check the status of the specified batch jobs and update the information in `batch_files/batch_jobs_info.json`.

#### Download Batch Results

```bash
# For all completed batch jobs
python scripts/openai_batch_helper.py --download --all

# For specific batch jobs
python scripts/openai_batch_helper.py --download --batch-id batch_abc123 batch_def456
```

This will download the results for the specified batch jobs and save them to `batch_files/{lang_code}/batch_output_{lang_code}_{timestamp}.jsonl`.

#### Process Batch Results

```bash
# For all downloaded batch results
python scripts/openai_batch_helper.py --process --all

# For specific languages
python scripts/openai_batch_helper.py --process --lang en-GB fr-FR
```

This will process the downloaded batch results using `transform_batch_output.py` and `augment_aac_data.py`.

## Options

- `--upload`: Upload batch files
- `--check`: Check batch job status
- `--download`: Download batch results
- `--process`: Process batch results
- `--workflow`: Run the complete workflow
- `--all`: Process all languages
- `--lang`: Specify language code(s) to process
- `--batch-id`: Specify batch job ID(s) to process
- `--poll-interval`: Interval in seconds to poll for batch job status (default: 300)

## Workflow

The complete workflow for generating multilingual AAC conversations using OpenAI's batch API is:

1. Generate batch files:
   ```bash
   python scripts/direct_multilingual_generate.py --lang all --num 100 --batch-prepare
   ```

2. Upload, monitor, download, and process:
   ```bash
   python scripts/openai_batch_helper.py --workflow --all
   ```

This will create augmented AAC conversations for all supported languages.

## Batch Job Information

The script maintains information about batch jobs in `batch_files/batch_jobs_info.json`. This file contains:

- `batch_id`: The OpenAI batch job ID
- `file_id`: The OpenAI file ID
- `lang_code`: The language code
- `batch_file`: The path to the batch file
- `status`: The status of the batch job
- `created_at`: When the batch job was created
- `completed_at`: When the batch job was completed
- `result_file`: The path to the downloaded result file
- `processed`: Whether the result file has been processed

## Error Handling

The script includes error handling for common issues:

- Missing API key
- Rate limits
- Failed uploads
- Failed downloads
- Processing errors

If an error occurs, the script will print an error message and continue with the next batch file or job.

## Examples

### Generate and Process Conversations for All Languages

```bash
# Generate batch files
python scripts/direct_multilingual_generate.py --lang all --num 100 --batch-prepare

# Upload, monitor, download, and process
python scripts/openai_batch_helper.py --workflow --all
```

### Generate and Process Conversations for Specific Languages

```bash
# Generate batch files
python scripts/direct_multilingual_generate.py --lang en-GB fr-FR --num 100 --batch-prepare

# Upload, monitor, download, and process
python scripts/openai_batch_helper.py --workflow --lang en-GB fr-FR
```

### Check Status of All Batch Jobs

```bash
python scripts/openai_batch_helper.py --check --all
```

### Download Results for Completed Batch Jobs

```bash
python scripts/openai_batch_helper.py --download --all
```

### Process Downloaded Results

```bash
python scripts/openai_batch_helper.py --process --all
```

## Troubleshooting

### API Key Issues

Make sure your OpenAI API key is set as an environment variable:

```bash
export OPENAI_API_KEY=your_api_key_here
```

### Rate Limits

If you hit rate limits, the script will print an error message. You can try again later or reduce the number of batch files you're uploading at once.

### Batch Job Status

If a batch job is taking a long time to complete, you can check its status:

```bash
python scripts/openai_batch_helper.py --check --batch-id batch_abc123
```

### Downloading Results

If you need to re-download results for a batch job:

```bash
# First update the status to remove the result_file
python -c "import json; f = open('batch_files/batch_jobs_info.json', 'r'); data = json.load(f); f.close(); data['batch_jobs']['batch_abc123']['result_file'] = None; f = open('batch_files/batch_jobs_info.json', 'w'); json.dump(data, f, indent=2); f.close()"

# Then download the results
python scripts/openai_batch_helper.py --download --batch-id batch_abc123
```

### Processing Results

If you need to re-process results:

```bash
# First update the status to remove the processed flag
python -c "import json; f = open('batch_files/batch_jobs_info.json', 'r'); data = json.load(f); f.close(); data['batch_jobs']['batch_abc123']['processed'] = False; f = open('batch_files/batch_jobs_info.json', 'w'); json.dump(data, f, indent=2); f.close()"

# Then process the results
python scripts/openai_batch_helper.py --process --lang en-GB
```
